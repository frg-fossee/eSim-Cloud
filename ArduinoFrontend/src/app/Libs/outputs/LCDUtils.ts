// import _ from 'lodash';
import _ from 'lodash-transpose';

// https://mil.ufl.edu/3744/docs/lcdmanual/commands.html
const FontData5x8 = {
    ' ': [0x00, 0x00, 0x00, 0x00, 0x00],
    '!': [0x00, 0x00, 0x5F, 0x00, 0x00],
    '"': [0x00, 0x07, 0x00, 0x07, 0x00],
    '#': [0x14, 0x7F, 0x14, 0x7F, 0x14],
      $: [0x24, 0x2A, 0x7F, 0x2A, 0x12],
    '%': [0x23, 0x13, 0x08, 0x64, 0x62],
    '&': [0x36, 0x49, 0x55, 0x22, 0x50],
    '\'': [0x00, 0x05, 0x03, 0x00, 0x00],
    '(': [0x00, 0x1C, 0x22, 0x41, 0x00],
    ')': [0x00, 0x41, 0x22, 0x1C, 0x00],
    '*': [0x08, 0x2A, 0x1C, 0x2A, 0x08],
    '+': [0x08, 0x08, 0x3E, 0x08, 0x08],
    ',': [0x00, 0x50, 0x30, 0x00, 0x00],
    '-': [0x08, 0x08, 0x08, 0x08, 0x08],
    '.': [0x00, 0x60, 0x60, 0x00, 0x00],
    '/': [0x20, 0x10, 0x08, 0x04, 0x02],
      0: [0x3E, 0x51, 0x49, 0x45, 0x3E],
      1: [0x00, 0x42, 0x7F, 0x40, 0x00],
      2: [0x42, 0x61, 0x51, 0x49, 0x46],
      3: [0x21, 0x41, 0x45, 0x4B, 0x31],
      4: [0x18, 0x14, 0x12, 0x7F, 0x10],
      5: [0x27, 0x45, 0x45, 0x45, 0x39],
      6: [0x3C, 0x4A, 0x49, 0x49, 0x30],
      7: [0x01, 0x71, 0x09, 0x05, 0x03],
      8: [0x36, 0x49, 0x49, 0x49, 0x36],
      9: [0x06, 0x49, 0x49, 0x29, 0x1E],
    ':': [0x00, 0x36, 0x36, 0x00, 0x00],
    ';': [0x00, 0x56, 0x36, 0x00, 0x00],
    '<': [0x00, 0x08, 0x14, 0x22, 0x41],
    '=': [0x14, 0x14, 0x14, 0x14, 0x14],
    '>': [0x41, 0x22, 0x14, 0x08, 0x00],
    '?': [0x02, 0x01, 0x51, 0x09, 0x06],
    '@': [0x32, 0x49, 0x79, 0x41, 0x3E],
      A: [0x7E, 0x11, 0x11, 0x11, 0x7E],
      B: [0x7F, 0x49, 0x49, 0x49, 0x36],
      C: [0x3E, 0x41, 0x41, 0x41, 0x22],
      D: [0x7F, 0x41, 0x41, 0x22, 0x1C],
      E: [0x7F, 0x49, 0x49, 0x49, 0x41],
      F: [0x7F, 0x09, 0x09, 0x01, 0x01],
      G: [0x3E, 0x41, 0x41, 0x51, 0x32],
      H: [0x7F, 0x08, 0x08, 0x08, 0x7F],
      I: [0x00, 0x41, 0x7F, 0x41, 0x00],
      J: [0x20, 0x40, 0x41, 0x3F, 0x01],
      K: [0x7F, 0x08, 0x14, 0x22, 0x41],
      L: [0x7F, 0x40, 0x40, 0x40, 0x40],
      M: [0x7F, 0x02, 0x04, 0x02, 0x7F],
      N: [0x7F, 0x04, 0x08, 0x10, 0x7F],
      O: [0x3E, 0x41, 0x41, 0x41, 0x3E],
      P: [0x7F, 0x09, 0x09, 0x09, 0x06],
      Q: [0x3E, 0x41, 0x51, 0x21, 0x5E],
      R: [0x7F, 0x09, 0x19, 0x29, 0x46],
      S: [0x46, 0x49, 0x49, 0x49, 0x31],
      T: [0x01, 0x01, 0x7F, 0x01, 0x01],
      U: [0x3F, 0x40, 0x40, 0x40, 0x3F],
      V: [0x1F, 0x20, 0x40, 0x20, 0x1F],
      W: [0x7F, 0x20, 0x18, 0x20, 0x7F],
      X: [0x63, 0x14, 0x08, 0x14, 0x63],
      Y: [0x03, 0x04, 0x78, 0x04, 0x03],
      Z: [0x61, 0x51, 0x49, 0x45, 0x43],
      Ä: [0x7D, 0x12, 0x12, 0x7D, 0x00],
      Ö: [0x3D, 0x42, 0x42, 0x42, 0x3D],
      Ü: [0x3D, 0x40, 0x40, 0x40, 0x3D],
    '[': [0x00, 0x00, 0x7F, 0x41, 0x41],
    '\\': [0x02, 0x04, 0x08, 0x10, 0x20],
    ']': [0x41, 0x41, 0x7F, 0x00, 0x00],
    '^': [0x04, 0x02, 0x01, 0x02, 0x04],
      _: [0x40, 0x40, 0x40, 0x40, 0x40],
    '`': [0x00, 0x01, 0x02, 0x04, 0x00],
      a: [0x20, 0x54, 0x54, 0x54, 0x78],
      b: [0x7F, 0x48, 0x44, 0x44, 0x38],
      c: [0x38, 0x44, 0x44, 0x44, 0x20],
      d: [0x38, 0x44, 0x44, 0x48, 0x7F],
      e: [0x38, 0x54, 0x54, 0x54, 0x18],
      f: [0x08, 0x7E, 0x09, 0x01, 0x02],
      g: [0x08, 0x14, 0x54, 0x54, 0x3C],
      h: [0x7F, 0x08, 0x04, 0x04, 0x78],
      i: [0x00, 0x44, 0x7D, 0x40, 0x00],
      j: [0x20, 0x40, 0x44, 0x3D, 0x00],
      k: [0x00, 0x7F, 0x10, 0x28, 0x44],
      l: [0x00, 0x41, 0x7F, 0x40, 0x00],
      m: [0x7C, 0x04, 0x18, 0x04, 0x78],
      n: [0x7C, 0x08, 0x04, 0x04, 0x78],
      o: [0x38, 0x44, 0x44, 0x44, 0x38],
      p: [0x7C, 0x14, 0x14, 0x14, 0x08],
      q: [0x08, 0x14, 0x14, 0x18, 0x7C],
      r: [0x7C, 0x08, 0x04, 0x04, 0x08],
      s: [0x48, 0x54, 0x54, 0x54, 0x20],
      t: [0x04, 0x3F, 0x44, 0x40, 0x20],
      u: [0x3C, 0x40, 0x40, 0x20, 0x7C],
      v: [0x1C, 0x20, 0x40, 0x20, 0x1C],
      w: [0x3C, 0x40, 0x30, 0x40, 0x3C],
      x: [0x44, 0x28, 0x10, 0x28, 0x44],
      y: [0x0C, 0x50, 0x50, 0x50, 0x3C],
      z: [0x44, 0x64, 0x54, 0x4C, 0x44],
      ä: [0x20, 0x55, 0x54, 0x55, 0x78],
      ö: [0x3A, 0x44, 0x44, 0x3A, 0x00],
      ü: [0x3A, 0x40, 0x40, 0x3A, 0x00],
    '{': [0x00, 0x08, 0x36, 0x41, 0x00],
    '|': [0x00, 0x00, 0x7F, 0x00, 0x00],
    '}': [0x00, 0x41, 0x36, 0x08, 0x00],
    '€': [0x14, 0x3E, 0x55, 0x41, 0x22],
    '†': [0x08, 0x08, 0x2A, 0x1C, 0x08],
    '‡': [0x08, 0x1C, 0x2A, 0x08, 0x08],
    '°': [0x00, 0x00, 0x07, 0x05, 0x07]
  };

export enum InstructionType {
    ClearDisplay = 1,
    CursorHome = 2,
    EntryModeSet = 3,
    DisplayOnOff = 4,
    CursorDisplayShift = 5,
    FunctionSet = 6,
}

function hex2bin(hex) {
  return ('00000000' + hex.toString(2)).substr(-8);
}

export class LCDUtils {
  static blankBytes: any = null;

  static getDisplayBytes(character: number): boolean[][] {
    const charString = String.fromCharCode(character);
    if (!(charString in FontData5x8)) {
        return LCDUtils.getBlankDisplayBytes();
      }
    const hexReprArray = FontData5x8[charString];
    const binRepr = hexReprArray.map(hexRepr => hex2bin(hexRepr).split('').map(n => parseInt(n, 2) & 1));
    return _.transpose(binRepr).reverse();
  }

  static getBlankDisplayBytes(): boolean[][] {
    if (!LCDUtils.blankBytes) {
      LCDUtils.blankBytes = LCDUtils.getDisplayBytes(' '.charCodeAt(0));
    }
    return LCDUtils.blankBytes;
  }

  static generateCGROM() {
    const CGROM = [[]];
    for (let character = 0; character < 0xFF; character++) {
      const higherBits = (character >> 4) & 0b1111;
      const lowerBits = (character) & 0b1111;
      CGROM[higherBits] = CGROM[higherBits] || [];
      CGROM[higherBits][lowerBits] = LCDUtils.getDisplayBytes(character);
    }
    return CGROM;
  }

  static generateDDRAM(N_ROW) {
    const blankBytes = LCDUtils.getBlankDisplayBytes();
    if (N_ROW === 1) {
      return [_.times(40, _.cloneDeep(blankBytes))];
    } else if (N_ROW === 2) {
      return [
        _.times(40, _.cloneDeep(blankBytes)),
        _.times(40, _.cloneDeep(blankBytes))
      ];
    } else if (N_ROW === 4) {
      return [
        _.times(20, _.cloneDeep(blankBytes)),
        _.times(20, _.cloneDeep(blankBytes)),
        _.times(20, _.cloneDeep(blankBytes)),
        _.times(20, _.cloneDeep(blankBytes))
      ];
    }
  }

  static getInstructionType(databus: number) {
      const dataBusBinary = Number(databus).toString(2);
      let firstOnePositionFromLeft = -1;
      for (let i = 0; i < dataBusBinary.length; i++) {
          if (dataBusBinary[i] === '1') {
              firstOnePositionFromLeft = i;
              break;
          }
      }
      const firstOnePositionFromRight = dataBusBinary.length - firstOnePositionFromLeft;
      return firstOnePositionFromRight;
  }
}
